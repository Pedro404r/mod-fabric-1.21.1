plugins {
	id 'fabric-loom' version "${loom_version}"
	id 'maven-publish'
}

// ----------------------------------------------------------------------------------
// ‚≠ê IN√çCIO DO GERENCIAMENTO DE VERS√ÉO CUSTOMIZADO
// ----------------------------------------------------------------------------------

// 1. Define o arquivo de propriedades
def propsFile = file("gradle.properties")
def props = new Properties()
props.load(new FileInputStream(propsFile))
def currentVersion = props.getProperty("mod_version")

// 2. Define a vers√£o do projeto:
//    - Se for fornecida via linha de comando (-Pmod_version=X.X.X), usa o valor da linha de comando.
//    - Caso contr√°rio, usa o valor atual do gradle.properties.
version = project.hasProperty('mod_version') ? project.getProperty('mod_version') : currentVersion
group = project.maven_group

// 3. Tarefa para AUTOMATICAMENTE INCREMENTAR a vers√£o no gradle.properties
task bumpVersion {
    doLast {
        def versionToUse = project.hasProperty('mod_version') ? project.getProperty('mod_version') : currentVersion
        
        // Separa a vers√£o (ex: 1.0.5)
        def parts = versionToUse.tokenize('.')
        
        // Verifica se √© uma vers√£o patch (tr√™s n√∫meros)
        if (parts.size() < 3) {
            println "‚ùå Erro: A vers√£o '${versionToUse}' n√£o est√° no formato X.Y.Z. N√£o foi poss√≠vel incrementar."
            return
        }
        
        // Incrementa o √∫ltimo n√∫mero (patch)
        def patch = (parts[-1] as int) + 1
        def newVersion = parts[0] + '.' + parts[1] + '.' + patch

        // Salva a nova vers√£o no arquivo
        props.setProperty("mod_version", newVersion)
        props.store(new FileOutputStream(propsFile), null)
        
        println "üîº Vers√£o incrementada em gradle.properties: ${versionToUse} ‚Üí ${newVersion}"
        println "‚ùó Lembre-se: A pr√≥xima build (sem -Pmod_version) usar√° ${newVersion}."
    }
}

// ----------------------------------------------------------------------------------
// ‚≠ê FIM DO GERENCIAMENTO DE VERS√ÉO CUSTOMIZADO
// ----------------------------------------------------------------------------------

base {
	archivesName = project.archives_base_name 	
}

// ... (O resto do seu c√≥digo permanece igual) ...
repositories {
	// ... (reposit√≥rios) ...
}

fabricApi {
	configureDataGeneration {
		client = true
	}
}

dependencies {
	// ... (depend√™ncias) ...
	minecraft "com.mojang:minecraft:${project.minecraft_version}"
	mappings "net.fabricmc:yarn:${project.yarn_mappings}:v2"
	modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"

	// Fabric API. This is technically optional, but you probably want it anyway.
	modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_version}"
	
}

processResources {
	// Usa a vers√£o DEFINIDA no topo do arquivo (que pode vir do -P)
	inputs.property "version", project.version

	filesMatching("fabric.mod.json") {
		expand "version": inputs.properties.version
	}
}

tasks.withType(JavaCompile).configureEach {
	it.options.release = 21
}

java {
	// ... (Java configs) ...
	withSourcesJar()
	sourceCompatibility = JavaVersion.VERSION_21
	targetCompatibility = JavaVersion.VERSION_21
}

jar {
	inputs.property "archivesName", project.base.archivesName

	from("LICENSE") {
		rename { "${it}_${inputs.properties.archivesName}"}
	}
}

// configure the maven publication
publishing {
	publications {
		create("mavenJava", MavenPublication) {
			artifactId = project.archives_base_name
			from components.java
		}
	}
	// ... (publishing repos) ...
}
